!function(e){!function(a){e.console||(e.console={log:function(){}}),ko.bindingHandlers.playSound={init:function(e,s){s().subscribe(function(){a(e)[0].play()})}},ko.bindingHandlers.scrollBottom={init:function(e,s){s().subscribe(function(){a(e).animate({scrollTop:a(e).prop("scrollHeight")},"fast")})}},ko.bindingHandlers.autoResize={init:function(e,s){a(e).autosize({append:""}),a(e).val("dummy"),a(e).trigger("autosize.resize"),a(e).val(""),s().subscribe(function(){a(e).trigger("autosize.resize")})}},ko.bindingHandlers.pressEnter={init:function(e,a,s,o){ko.utils.registerEventHandler(e,"keydown",function(s){13!==s.keyCode||s.shiftKey||(s.preventDefault(),a().call(o,e))})}},ko.bindingHandlers.fadeVisible={init:function(e,s){a(e).toggle(ko.utils.unwrapObservable(s()))},update:function(e,s,o){var n=s(),t=e;o.has("xFadeTarget")?ko.utils.unwrapObservable(n)?a(t).fadeIn("fast").promise().done(function(){o.get("xFadeTarget")(!1)}):a(t).fadeOut("fast").promise().done(function(){o.get("xFadeTarget")(!0)}):ko.utils.unwrapObservable(n)?a(t).fadeIn("fast"):a(t).fadeOut("fast")}},ko.validation.init({insertMessages:!1,decorateInputElement:!0});var s=function(s){var o=this;o.displayTerminal=ko.observable(!1),o.displayReplyForm=ko.observable(!1),o.conversations=ko.observableArray(),o.chatMessages=ko.observableArray(),o.onRenderChatMessage=ko.observable(),o.chatMessageToSend=ko.observable(),o.existsChatMessage=ko.observable(!1),o.focusReplyForm=ko.observable(!1),o.systemMessage=ko.observable(""),o.enableControl=ko.observable(!0),o.doMessageAlert=ko.observable(!1),o.doConversationAlert=ko.observable(!1),o.conversationsMeta={},o.needMessageAlert=!1,o.conversationAlert=!1,o.processingSendChatMessage=!1,o.processingPollChatMessage=!1,o.processingPollConversation=!1,o.lastReceivedConversationId=0,o.activeConversationId=ko.observable(0),o.conversationMissingCount=0,o.conversationPolling,o.lastReceivedMessageId=0,o.chatMessageMissingCount=0,o.chatMessagePolling,o.unload=!1,o.init=function(){a.ajaxSetup({cache:!1,type:"post",dataType:"json",url:s.ajaxUrl}),a(e).on("beforeunload",function(){o.unload=!0}),s.loggedIn?s.conversationId?o.joinConversation({id:s.conversationId}):o.pollConversation():o.login()},o.login=function(){a.ajax({data:{action:"chamameLoginOperator",token:s.token}}).done(function(e){return"failure"===e.status?void o.abort(s.text.error):void o.pollConversation()}).fail(function(){o.abort(s.text.error)}).always()},o.joinConversation=function(e){!o.processingJoinConversation&&o.enableControl()&&(o.processingJoinConversation=!0,o.stopPolling(o.conversationPolling),o.stopPolling(o.chatMessagePolling),o.conversationsMeta[e.id]?o.conversationsMeta[e.id].read=!0:o.conversationsMeta[e.id]={lastMessageId:0,read:!0},o.lastReceivedMessageId=0,o.chatMessages.removeAll(),o.displayReplyForm(!1),a.ajax({data:{action:"chamameJoinConversation",token:s.token,conversationId:e.id}}).done(function(a){return"failure"===a.status?void o.abort(s.text.error):(o.displayTerminal(!0),o.activeConversationId(e.id),o.needMessageAlert=!1,o.conversationAlert=!1,o.pollConversation(),o.pollChatMessage(),o.displayReplyForm(!0),void o.focusReplyForm(!0))}).fail(function(){o.abort(s.text.error)}).always(function(){setTimeout(function(){o.processingJoinConversation=!1},500)}))},o.leaveConversation=function(){o.stopPolling(o.chatMessagePolling),a.ajax({data:{action:"chamameLeaveConversation",token:s.token}}).done(function(e){"failure"===e.status}).fail(function(){}).always(function(){o.activeConversationId(0),o.lastReceivedMessageId=0,o.chatMessages.removeAll(),o.displayTerminal(!1),o.displayReplyForm(!1),o.focusReplyForm(!1)})},o.pollConversation=function(){if(!o.processingPollConversation){o.processingPollConversation=!0;var e=!1;a.ajax({data:{action:"chamameGetConversations",token:s.token}}).done(function(n){if("failure"===n.status)return void o.abort(s.text.error);o.conversations.removeAll(),0===n.data.length?o.conversationMissingCount+=1:(o.conversationMissingCount=0,a.each(n.data,function(a,s){o.renderConversation(s),o.conversationAlert&&s.id>o.lastReceivedConversationId&&(e=!0),o.lastReceivedConversationId=Math.max(o.lastReceivedConversationId,s.id)})),e&&o.playConversationAlertSound(),o.conversationAlert=!0;var t=3e3;o.conversationMissingCount>10&&(t=6e3),o.processingPollConversation=!1,o.conversationPolling=setTimeout(o.pollConversation,t)}).fail(function(){o.abort(s.text.error),o.processingPollConversation=!1}).always(function(){})}},o.renderConversation=function(e){var a=o.conversationsMeta;a[e.id]?(a[e.id].read&&o.activeConversationId()!=e.id&&(a[e.id].read=e.lastMessageId<=a[e.id].lastMessageId),a[e.id].lastMessageId=e.lastMessageId):a[e.id]={lastMessageId:e.lastMessageId,read:!1},o.conversations.push({id:e.id,senderName:e.senderName,lastTimestamp:e.lastMessageTimestamp,lastMessage:e.lastMessageTruncated,lastSenderName:e.lastMessageSenderName,read:a[e.id].read})},o.pollChatMessage=function(){o.processingPollChatMessage||(o.processingPollChatMessage=!0,a.ajax({data:{action:"chamameGetUnreadMessage",token:s.token,lastReceivedMessageId:o.lastReceivedMessageId}}).done(function(e){if("failure"===e.status)return o.displayTerminal()&&o.abort(s.text.error),void(o.processingPollChatMessage=!1);0===e.data.length?o.chatMessageMissingCount+=1:(o.chatMessageMissingCount=0,a.each(e.data,function(e,a){var s=parseInt(a.id);s!==o.lastReceivedMessageId&&o.renderChatMessage(a),s>o.lastReceivedMessageId&&(o.lastReceivedMessageId=s)}),o.scrollTerminal(),o.needMessageAlert&&o.playChatMessageAlertSound(),o.needMessageAlert=!0);var n=1e3,t=o.chatMessageMissingCount;t>2&&(n=2e3),t>4&&(n=3e3),t>6&&(n=4e3),t>10&&(n=5e3),t>15&&(n=13e3),o.processingPollChatMessage=!1,o.chatMessagePolling=setTimeout(o.pollChatMessage,n)}).fail(function(){o.abort(s.text.error),o.processingPollChatMessage=!1}).always(function(){}))},o.renderChatMessage=function(e){o.chatMessages.push({message:e.message,senderName:e.senderName,timestamp:e.timestamp}),o.existsChatMessage(!0)},o.sendChatMessage=function(){if(!o.processingSendChatMessage){o.processingSendChatMessage=!0,o.stopPolling(o.conversationPolling),o.stopPolling(o.chatMessagePolling);var e=o.chatMessageToSend();return e=a.trim(e),""===e?(o.chatMessageToSend(""),o.processingSendChatMessage=!1,o.pollConversation(),void o.pollChatMessage()):void a.ajax({data:{action:"chamameSendMessage",token:s.token,chatMessage:e}}).done(function(e){return"failure"===e.status?void o.abort(s.text.error):(o.chatMessageToSend(""),o.chatMessageMissingCount=0,o.needMessageAlert=!1,o.pollConversation(),void o.pollChatMessage())}).fail(function(){o.abort(s.text.error)}).always(function(){o.processingSendChatMessage=!1})}},o.stopPolling=function(e){clearTimeout(e)},o.scrollTerminal=function(){var e=o.onRenderChatMessage();o.onRenderChatMessage(!e)},o.abort=function(e){o.stopPolling(o.chatMessagePolling),o.stopPolling(o.conversationPolling),o.unload||(o.enableControl(!1),o.systemMessage(e))},o.playChatMessageAlertSound=function(){var e=o.doMessageAlert();o.doMessageAlert(!e)},o.playConversationAlertSound=function(){var e=o.doConversationAlert();o.doConversationAlert(!e)}};a(function(){var e=new s(chamameParams);e.init(),ko.applyBindings(ko.validatedObservable(e))})}(jQuery)}(this);