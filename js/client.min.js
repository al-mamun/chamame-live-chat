!function(e){!function(s){e.console||(e.console={log:function(){}}),ko.bindingHandlers.scrollBottom={init:function(e,a){a().subscribe(function(){s(e).animate({scrollTop:s(e).prop("scrollHeight")},"fast")})}},ko.bindingHandlers.autoResize={init:function(e,a){s(e).autosize({append:""}),s(e).val("dummy"),s(e).trigger("autosize.resize"),s(e).val(""),a().subscribe(function(){s(e).trigger("autosize.resize")})}},ko.bindingHandlers.pressEnter={init:function(e,s,a,o){ko.utils.registerEventHandler(e,"keydown",function(a){13!==a.keyCode||a.shiftKey||(a.preventDefault(),s().call(o,e))})}},ko.bindingHandlers.fadeVisible={init:function(e,a){s(e).toggle(ko.utils.unwrapObservable(a()))},update:function(e,a){var o=a(),n=e;ko.utils.unwrapObservable(o)?s(n).fadeIn():s(n).fadeOut()}},ko.bindingHandlers.slideVisible={init:function(e,a){s(e).toggle(ko.utils.unwrapObservable(a()))},update:function(e,a){var o=a(),n=e;ko.utils.unwrapObservable(o)?s(n).slideDown():s(n).slideUp()}},ko.validation.init({insertMessages:!1,decorateInputElement:!0}),ko.validation.rules.looseEmail={validator:function(e){var s=new RegExp("^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:.[a-zA-Z0-9-]+)*$");return s.test(e)}},ko.validation.registerExtenders();var a=function(e){var a=this;a.userName=ko.observable("").extend({throttle:300}).extend({required:{message:e.text.nameRequired}}),a.userEmail=ko.observable("").extend({throttle:300}).extend({required:{message:e.text.emailRequired}}).extend({looseEmail:{message:e.text.emailFormat}}),a.chatMessageToSend=ko.observable(),a.chatMessages=ko.observableArray(),a.display=ko.observable(!1),a.displayContainer=ko.observable(!1),a.displayLoginForm=ko.observable(!0),a.displayTerminal=ko.observable(!1),a.systemMessage=ko.observable(""),a.existsChatMessage=ko.observable(!1),a.scroll=ko.observable(!1),a.focusLoginForm=ko.observable(!1),a.focusReplyForm=ko.observable(!1),a.enableControl=ko.observable(!0),a.polling,a.lastReceivedMessageId=0,a.missingCount=0,a.processingSendChatMessage=!1,a.processingPollChatMessage=!1,a.processingLoginOrLogout=!1,a.init=function(){s.ajaxSetup({cache:!1,type:"post",dataType:"json",url:chamameParams.ajaxUrl}),a.display(!0),e.loggedIn&&a.restore()},a.toggleContainer=function(){var e=a.displayContainer();a.displayContainer(!e),a.focusLoginForm(!e)},a.login=function(){if(!a.processingLoginOrLogout){if(a.processingLoginOrLogout=!0,!a.isValid())return a.errors.showAllMessages(),void(a.processingLoginOrLogout=!1);var o=a.userName(),n=a.userEmail();s.ajax({data:{action:"chamameLoginVisitor",token:e.token,userName:o,userEmail:n}}).done(function(s){return"failure"===s.status?(a.abort(e.text.error),void(a.processingLoginOrLogout=!1)):(a.displayLoginForm(!1),a.displayTerminal(!0),a.enableControl(!0),a.focusReplyForm(!0),a.pollChatMessage(),void(a.processingLoginOrLogout=!1))}).fail(function(){a.abort(e.text.error)}).always()}},a.logout=function(){a.processingLoginOrLogout||(a.processingLoginOrLogout=!0,a.stopPolling(),s.ajax({data:{action:"chamameLogout",token:e.token}}).done(function(e){"failure"===e.status,a.focusReplyForm(!1),a.displayTerminal(!1),a.displayLoginForm(!0),a.enableControl(!0),a.toggleContainer(),a.chatMessageToSend(""),a.chatMessages.removeAll(),a.missingCount=0,a.lastReceivedMessageId=0,a.processingSendChatMessage=!1,a.processingPollChatMessage=!1,a.systemMessage("")}).fail(function(){}).always(function(){setTimeout(function(){a.processingLoginOrLogout=!1},1e3)}))},a.restore=function(){a.displayContainer=ko.observable(!0),a.displayLoginForm=ko.observable(!1),a.displayTerminal=ko.observable(!0),s.ajax({data:{action:"chamameGetUnreadMessage",token:e.token,lastReceivedMessageId:a.lastReceivedMessageId}}).done(function(o){return"failure"===o.status?void a.abort(e.text.error):(o.data.length>0&&s.each(o.data,function(e,s){s.id!==a.lastReceivedMessageId&&a.renderChatMessage(s),s.id>a.lastReceivedMessageId&&(a.lastReceivedMessageId=s.id)}),a.scrollTerminal(),void a.pollChatMessage())}).fail(function(){a.abort(e.text.error)}).always()},a.pollChatMessage=function(){a.processingPollChatMessage||(a.processingPollChatMessage=!0,s.ajax({data:{action:"chamameGetUnreadMessage",token:e.token,lastReceivedMessageId:a.lastReceivedMessageId}}).done(function(o){if("failure"===o.status)return a.displayTerminal()&&a.abort(e.text.error),void(a.processingPollChatMessage=!1);0===o.data.length?a.missingCount+=1:(a.missingCount=0,s.each(o.data,function(e,s){var o=parseInt(s.id);o!==a.lastReceivedMessageId&&a.renderChatMessage(s),o>a.lastReceivedMessageId&&(a.lastReceivedMessageId=o)}),a.scrollTerminal());var n=1e3;a.missingCount>2&&(n=2e3),a.missingCount>4&&(n=3e3),a.missingCount>6&&(n=4e3),a.missingCount>10&&(n=5e3),a.missingCount>15&&(n=13e3),a.polling=setTimeout(a.pollChatMessage,n),a.processingPollChatMessage=!1}).fail(function(){a.abort(e.text.error)}).always())},a.stopPolling=function(){clearTimeout(a.polling)},a.sendChatMessage=function(){if(!a.processingSendChatMessage){a.processingSendChatMessage=!0,a.stopPolling();var o=a.chatMessageToSend();return o=s.trim(o),""===o?(a.chatMessageToSend(""),a.pollChatMessage(),void(a.processingSendChatMessage=!1)):void s.ajax({data:{action:"chamameSendMessage",token:e.token,chatMessage:o}}).done(function(s){return"failure"===s.status?void a.abort(e.text.error):(a.chatMessageToSend(""),a.missingCount=0,void a.scrollTerminal())}).fail(function(){a.abort(e.text.error)}).always(function(){a.processingSendChatMessage=!1,a.pollChatMessage()})}},a.renderChatMessage=function(e){a.chatMessages.push({message:e.message,senderName:e.senderName,timestamp:e.timestamp}),a.existsChatMessage(!0)},a.scrollTerminal=function(){v=a.scroll(),a.scroll(!v)},a.abort=function(e){a.stopPolling(),a.enableControl(!1),a.systemMessage(e)}};s(function(){var e=new a(chamameParams);e.init(),ko.applyBindings(ko.validatedObservable(e))})}(jQuery)}(this);